<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JEE Main 2026 - Study OS Pro</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Plus Jakarta Sans', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        background: '#050505',
                        surface: '#0a0a0a',
                        surfaceHighlight: '#171717',
                        border: '#262626',
                        primary: {
                            400: '#818cf8',
                            500: '#6366f1',
                            600: '#4f46e5',
                        }
                    },
                    zIndex: {
                        '60': '60',
                        '70': '70',
                        '100': '100',
                    }
                }
            }
        }
    </script>

    <style>
        /* Base & Scrollbar */
        body { background-color: #050505; color: #e5e5e5; overflow: hidden; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #404040; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #525252; }

        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none; width: 100%; background: transparent;
        }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 14px; width: 14px; border-radius: 50%; background: #6366f1; cursor: pointer; margin-top: -6px; box-shadow: 0 0 10px rgba(99,102,241,0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 2px; cursor: pointer; background: #404040; border-radius: 1px;
        }

        /* Cinema Mode Classes */
        body.cinema-mode #sidebar, 
        body.cinema-mode header, 
        body.cinema-mode #right-panel,
        body.cinema-mode #player-controls {
            opacity: 0.1; pointer-events: none; transition: opacity 0.5s ease;
        }
        body.cinema-mode #cinema-overlay { opacity: 1; pointer-events: auto; }
        body.cinema-mode #video-container { z-index: 60; box-shadow: 0 0 100px rgba(0,0,0,0.8); }

        /* Focus Mode Classes (Hides UI completely) */
        body.focus-mode #sidebar { width: 0; opacity: 0; padding: 0; overflow: hidden; border-right: 0; }
        body.focus-mode header { height: 0; opacity: 0; overflow: hidden; padding: 0; border-bottom: 0; }
        body.focus-mode #right-panel { width: 0; opacity: 0; overflow: hidden; border-left: 0; }

        /* Video Filters */
        .filter-invert { filter: invert(1) hue-rotate(180deg); }
        .filter-contrast { filter: contrast(1.2) brightness(1.1); }
    </style>
</head>
<body class="h-screen flex flex-col font-sans selection:bg-primary-500/30 selection:text-white">

    <!-- Cinema Overlay -->
    <div id="cinema-overlay" class="fixed inset-0 bg-black/95 z-50 opacity-0 pointer-events-none transition-opacity duration-500"></div>

    <!-- YouTube API (Loaded dynamically to prevent errors) -->
    <div id="yt-api-placeholder"></div>

    <!-- Header -->
    <header class="h-14 border-b border-border bg-background flex items-center justify-between px-4 z-40 flex-shrink-0 transition-all duration-300">
        <div class="flex items-center gap-4">
            <button onclick="toggleMobileSidebar()" class="lg:hidden p-2 text-zinc-400 hover:text-white rounded-lg">
                <i data-lucide="menu" class="w-5 h-5"></i>
            </button>
            <div class="flex items-center gap-3 cursor-pointer group" onclick="renderDashboard()">
                <div class="w-8 h-8 rounded-lg bg-primary-600 flex items-center justify-center shadow-lg shadow-primary-500/20">
                    <i data-lucide="zap" class="w-4 h-4 text-white fill-current"></i>
                </div>
                <div>
                    <h1 class="text-sm font-bold text-white tracking-tight">STUDY<span class="text-primary-500">OS</span></h1>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-2">
            <!-- Hidden Import Input -->
            <input type="file" id="import-input" accept=".json" class="hidden" onchange="processImport(this)">
            
            <button onclick="document.getElementById('import-input').click()" class="flex items-center gap-2 px-3 py-1.5 text-xs font-medium text-zinc-400 hover:text-white hover:bg-surfaceHighlight rounded-lg transition-colors border border-transparent hover:border-border">
                <i data-lucide="upload" class="w-3.5 h-3.5"></i> 
                <span class="hidden sm:inline">Import</span>
            </button>
            <button onclick="exportData()" class="flex items-center gap-2 px-3 py-1.5 text-xs font-medium text-zinc-400 hover:text-white hover:bg-surfaceHighlight rounded-lg transition-colors border border-transparent hover:border-border">
                <i data-lucide="download" class="w-3.5 h-3.5"></i>
                <span class="hidden sm:inline">Backup</span>
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-surface border-r border-border flex flex-col flex-shrink-0 z-30 transition-all duration-300 absolute lg:static h-full transform -translate-x-full lg:translate-x-0">
            <div class="p-3">
                <button onclick="renderDashboard()" id="nav-dash" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-xs font-bold transition-colors text-white bg-surfaceHighlight border border-border">
                    <i data-lucide="layout-grid" class="w-4 h-4"></i>
                    DASHBOARD
                </button>
            </div>
            <div class="px-4 pt-2 pb-2 flex items-center justify-between group">
                <span class="text-[10px] font-bold text-zinc-500 uppercase tracking-wider group-hover:text-zinc-300 transition-colors">FOLDERS</span>
                <button onclick="openModal('folder')" class="text-zinc-500 hover:text-white transition-colors p-1 hover:bg-surfaceHighlight rounded" title="New Folder">
                    <i data-lucide="plus" class="w-3.5 h-3.5"></i>
                </button>
            </div>
            <div id="sidebar-list" class="flex-1 overflow-y-auto px-2 pb-4 space-y-1 custom-scrollbar">
                <!-- List -->
            </div>
        </aside>

        <!-- Main Content Area (Flex container) -->
        <div class="flex-1 flex flex-col relative min-w-0 bg-background z-0">
            
            <!-- VIEW: DASHBOARD -->
            <main id="view-dashboard" class="flex-1 overflow-y-auto p-6 lg:p-10 relative z-10">
                <div class="max-w-7xl mx-auto space-y-8 animate-slide-up">
                    
                    <!-- Continue Watching Hero -->
                    <div id="hero-section" class="hidden relative group rounded-2xl overflow-hidden border border-border bg-surface">
                        <div class="absolute inset-0 bg-gradient-to-r from-primary-900/20 to-transparent"></div>
                        <div class="relative p-8 flex flex-col md:flex-row items-start md:items-center justify-between gap-6">
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider bg-primary-500 text-white">Continue</span>
                                </div>
                                <h2 id="hero-title" class="text-2xl font-bold text-white mb-1">Folder Name</h2>
                                <p id="hero-sub" class="text-zinc-400 text-sm font-mono">Lecture Title</p>
                            </div>
                            <button onclick="resumeLast()" class="px-6 py-3 bg-white text-black hover:bg-zinc-200 rounded-lg text-sm font-bold shadow-xl shadow-white/5 transition-transform hover:scale-105 flex items-center gap-2">
                                <i data-lucide="play" class="w-4 h-4 fill-current"></i> Resume
                            </button>
                        </div>
                    </div>

                    <!-- Grid -->
                    <div id="dash-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5"></div>
                    
                    <!-- Empty State -->
                    <div id="dash-empty" class="hidden flex-col items-center justify-center py-20 border-2 border-dashed border-border rounded-xl">
                        <div class="w-12 h-12 bg-surfaceHighlight rounded-full flex items-center justify-center mb-4 text-zinc-600">
                            <i data-lucide="folder" class="w-6 h-6"></i>
                        </div>
                        <p class="text-zinc-400 text-sm">No folders yet. Create one or import data.</p>
                    </div>
                </div>
            </main>

            <!-- VIEW: PLAYER (Initially Hidden) -->
            <main id="view-player" class="hidden flex-1 flex flex-col h-full absolute inset-0 bg-black z-20">
                
                <div class="flex-1 flex flex-row min-h-0">
                    <!-- Video Stage -->
                    <div class="flex-1 flex flex-col relative bg-black min-w-0">
                        
                        <!-- Video Container -->
                        <div id="video-container" class="flex-1 relative bg-black flex items-center justify-center group overflow-hidden">
                            <div id="yt-player-mount" class="w-full h-full relative z-10"></div>
                            <!-- Drag Drop Overlay -->
                            <div id="drag-overlay" class="absolute inset-0 z-50 bg-primary-500/10 hidden backdrop-blur-sm border-4 border-dashed border-primary-500/50 m-6 rounded-2xl flex items-center justify-center text-primary-200 font-bold text-xl">
                                Drop Video Here
                            </div>
                        </div>

                        <!-- Controls Deck -->
                        <div id="player-controls" class="bg-surface border-t border-border flex flex-col z-20 flex-shrink-0 transition-all duration-300">
                            
                            <!-- Top Bar: Title & View Modes -->
                            <div class="flex items-center justify-between px-4 py-2 border-b border-border/50">
                                <div class="flex items-center gap-3 min-w-0 mr-4">
                                    <button onclick="renderDashboard()" class="p-1.5 hover:bg-surfaceHighlight rounded-lg text-zinc-400 hover:text-white transition-colors" title="Back to Dashboard">
                                        <i data-lucide="arrow-left" class="w-4 h-4"></i>
                                    </button>
                                    <div class="min-w-0">
                                        <h2 id="player-title" class="text-xs font-bold text-white truncate">Select Video</h2>
                                        <p id="player-meta" class="text-[10px] text-zinc-500 truncate font-mono">--</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-1 bg-surfaceHighlight/50 rounded-lg p-1 border border-border">
                                    <button onclick="toggleInvert()" id="btn-invert" class="p-1.5 rounded text-zinc-400 hover:text-white hover:bg-surfaceHighlight" title="Invert Colors">
                                        <i data-lucide="contrast" class="w-3.5 h-3.5"></i>
                                    </button>
                                    <button onclick="toggleCinema()" id="btn-cinema" class="p-1.5 rounded text-zinc-400 hover:text-white hover:bg-surfaceHighlight" title="Cinema Mode">
                                        <i data-lucide="moon" class="w-3.5 h-3.5"></i>
                                    </button>
                                    <button onclick="toggleTheater()" id="btn-theater" class="p-1.5 rounded text-zinc-400 hover:text-white hover:bg-surfaceHighlight" title="Theater Mode">
                                        <i data-lucide="panel-right-close" class="w-3.5 h-3.5"></i>
                                    </button>
                                    <button onclick="toggleFocus()" id="btn-focus" class="p-1.5 rounded text-zinc-400 hover:text-primary-400 hover:bg-surfaceHighlight" title="Focus Mode">
                                        <i data-lucide="maximize" class="w-3.5 h-3.5"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Bottom Bar: Slider & Repeater -->
                            <div class="flex items-center justify-between px-4 py-3 bg-surfaceHighlight/10 gap-6 overflow-x-auto">
                                
                                <!-- Speed Slider -->
                                <div class="flex items-center gap-3 flex-1 max-w-xs">
                                    <div class="text-[10px] font-bold text-zinc-500 uppercase tracking-wider whitespace-nowrap">Speed <span id="speed-val" class="text-white ml-1 font-mono">1.0x</span></div>
                                    <input type="range" min="0.5" max="4.0" step="0.1" value="1.0" oninput="setSpeed(this.value)" class="flex-1">
                                </div>

                                <!-- Repeater -->
                                <div class="flex items-center gap-2 border-l border-border pl-4">
                                    <span class="text-[10px] font-bold text-zinc-500 uppercase tracking-wider">Loop</span>
                                    <div class="flex items-center bg-surface border border-border rounded overflow-hidden">
                                        <button onclick="setLoopPoint('A')" id="btn-loop-a" class="px-3 py-1 text-[10px] font-mono hover:bg-primary-500/20 hover:text-primary-400 transition-colors border-r border-border text-zinc-400">A</button>
                                        <button onclick="setLoopPoint('B')" id="btn-loop-b" class="px-3 py-1 text-[10px] font-mono hover:bg-primary-500/20 hover:text-primary-400 transition-colors border-r border-border text-zinc-400">B</button>
                                        <button onclick="toggleLoop()" id="btn-loop-toggle" class="px-2 py-1 text-zinc-500 hover:text-white hover:bg-surfaceHighlight transition-colors">
                                            <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                                        </button>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                    <!-- Right Panel (Playlist) -->
                    <div id="right-panel" class="w-80 bg-surface border-l border-border flex flex-col flex-shrink-0 transition-all duration-300">
                        <div class="p-3 border-b border-border flex gap-2">
                            <div class="relative flex-1">
                                <i data-lucide="search" class="absolute left-2.5 top-2.5 w-3.5 h-3.5 text-zinc-500"></i>
                                <input type="text" id="playlist-search" oninput="renderPlaylist()" placeholder="Search..." class="w-full bg-background border border-border rounded-md pl-8 py-2 text-xs text-white focus:outline-none focus:border-primary-500">
                            </div>
                            <button onclick="openModal('video')" class="p-2 bg-primary-600 hover:bg-primary-500 text-white rounded-md shadow-lg shadow-primary-500/20">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div id="playlist-container" class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar"></div>
                        <div class="p-2 border-t border-border bg-surface flex justify-between items-center px-4">
                            <span id="playlist-stats" class="text-[10px] text-zinc-500">0/0 Watched</span>
                            <button onclick="openModal('edit-folder')" class="text-zinc-500 hover:text-white"><i data-lucide="settings-2" class="w-3.5 h-3.5"></i></button>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] hidden opacity-0 transition-opacity flex items-center justify-center p-4">
        
        <!-- Add Folder -->
        <div id="modal-folder" class="bg-surface border border-border w-full max-w-sm rounded-xl p-6 shadow-2xl scale-95 opacity-0 transition-all transform hidden">
            <h3 class="text-lg font-bold text-white mb-1">New Folder</h3>
            <p class="text-xs text-zinc-500 mb-5">Create a folder to organize lectures.</p>
            <input type="text" id="inp-folder-name" class="w-full bg-background border border-border rounded-lg p-2.5 text-sm text-white focus:border-primary-500 focus:outline-none placeholder-zinc-700 mb-4" placeholder="e.g. Physics - Optics">
            <div class="flex justify-end gap-2">
                <button onclick="closeModals()" class="px-4 py-2 text-xs font-medium text-zinc-400 hover:text-white">Cancel</button>
                <button onclick="createFolder()" class="px-4 py-2 bg-primary-600 hover:bg-primary-500 text-white rounded-lg text-xs font-medium">Create</button>
            </div>
        </div>

        <!-- Add Video -->
        <div id="modal-video" class="bg-surface border border-border w-full max-w-md rounded-xl p-6 shadow-2xl scale-95 opacity-0 transition-all transform hidden">
            <h3 class="text-lg font-bold text-white mb-1">Add Lecture</h3>
            <p class="text-xs text-zinc-500 mb-5">Paste a YouTube link.</p>
            <div class="space-y-4">
                <input type="text" id="inp-video-url" class="w-full bg-background border border-border rounded-lg p-2.5 text-sm text-white focus:border-primary-500 focus:outline-none" placeholder="https://youtu.be/...">
                <input type="text" id="inp-video-title" class="w-full bg-background border border-border rounded-lg p-2.5 text-sm text-white focus:border-primary-500 focus:outline-none" placeholder="Title (Optional)">
                <div>
                    <label class="text-[10px] font-bold text-zinc-500 mb-2 block">Tag</label>
                    <div class="grid grid-cols-4 gap-2">
                        <button onclick="setTag('Lecture')" class="tag-btn text-xs border rounded-lg py-2 text-zinc-500 border-border hover:bg-surfaceHighlight" data-tag="Lecture">Lecture</button>
                        <button onclick="setTag('Concept')" class="tag-btn text-xs border rounded-lg py-2 text-zinc-500 border-border hover:bg-surfaceHighlight" data-tag="Concept">Concept</button>
                        <button onclick="setTag('PYQ')" class="tag-btn text-xs border rounded-lg py-2 text-zinc-500 border-border hover:bg-surfaceHighlight" data-tag="PYQ">PYQ</button>
                        <button onclick="setTag('Revision')" class="tag-btn text-xs border rounded-lg py-2 text-zinc-500 border-border hover:bg-surfaceHighlight" data-tag="Revision">Revision</button>
                    </div>
                    <input type="hidden" id="inp-video-tag" value="Lecture">
                </div>
                <div class="flex justify-end gap-2 pt-2">
                    <button onclick="closeModals()" class="px-4 py-2 text-xs font-medium text-zinc-400 hover:text-white">Cancel</button>
                    <button onclick="addVideo()" class="px-4 py-2 bg-primary-600 hover:bg-primary-500 text-white rounded-lg text-xs font-medium">Add Video</button>
                </div>
            </div>
        </div>

        <!-- Edit Folder -->
        <div id="modal-edit-folder" class="bg-surface border border-border w-full max-w-sm rounded-xl p-6 shadow-2xl scale-95 opacity-0 transition-all transform hidden">
            <h3 class="text-lg font-bold text-white mb-4">Manage Folder</h3>
            <input type="text" id="inp-edit-name" class="w-full bg-background border border-border rounded-lg p-2.5 text-sm text-white focus:border-primary-500 focus:outline-none mb-4">
            <button onclick="deleteCurrentFolder()" class="w-full py-2.5 text-xs font-medium text-red-400 hover:bg-red-500/10 rounded-lg border border-red-500/20 flex items-center justify-center gap-2 mb-2">
                <i data-lucide="trash-2" class="w-3.5 h-3.5"></i> Delete Folder
            </button>
            <div class="flex justify-end gap-2 pt-2 border-t border-border">
                <button onclick="closeModals()" class="px-4 py-2 text-xs font-medium text-zinc-400 hover:text-white">Cancel</button>
                <button onclick="saveEditFolder()" class="px-4 py-2 bg-white text-black hover:bg-zinc-200 rounded-lg text-xs font-semibold">Save</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 right-6 z-[110] transition-all duration-300 transform translate-y-20 opacity-0 pointer-events-none">
        <div class="bg-surface border border-border text-white px-4 py-3 rounded-lg shadow-2xl flex items-center gap-3">
            <i id="toast-icon" data-lucide="check-circle" class="w-4 h-4 text-emerald-400"></i>
            <span id="toast-msg" class="text-xs font-medium">Notification</span>
        </div>
    </div>

    <!-- Javascript -->
    <script>
        // --- DATA & STATE ---
        const DB_KEY = 'jee_os_v4';
        let db = { folders: [], lastPlayed: null };
        let activeFolderId = null;
        let activeVideoId = null;
        
        let player = null;
        let ytApiReady = false;
        
        // Loop State
        let loopStart = null;
        let loopEnd = null;
        let isLooping = false;
        let loopInterval = null;

        // --- INIT ---
        function init() {
            const saved = localStorage.getItem(DB_KEY);
            if(saved) {
                try { db = JSON.parse(saved); } catch(e) { console.error(e); }
            } else {
                const fid = uid();
                db = { folders: [{id: fid, name: 'Physics - Mechanics', videos: []}], lastPlayed: null };
                save();
            }

            renderSidebar();
            renderDashboard();
            lucide.createIcons();
            setupDragDrop();

            // Load Youtube API Robustly
            if (!window.YT) {
                const tag = document.createElement('script');
                tag.src = "https://www.youtube.com/iframe_api";
                const firstScriptTag = document.getElementsByTagName('script')[0];
                firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
            }
        }

        window.onYouTubeIframeAPIReady = function() {
            ytApiReady = true;
        }

        // --- CORE FUNCTIONS ---
        function save() { localStorage.setItem(DB_KEY, JSON.stringify(db)); }
        function uid() { return Math.random().toString(36).substr(2, 9); }
        function getFolder(id) { return db.folders.find(f => f.id === id); }

        function renderDashboard() {
            // Layout Swap
            document.getElementById('view-dashboard').classList.remove('hidden');
            document.getElementById('view-player').classList.add('hidden');
            activeFolderId = null; // Clear active context
            
            // Render Grid
            const grid = document.getElementById('dash-grid');
            grid.innerHTML = '';
            
            if(db.folders.length === 0) document.getElementById('dash-empty').classList.remove('hidden');
            else document.getElementById('dash-empty').classList.add('hidden');

            // Hero Section Logic
            const hero = document.getElementById('hero-section');
            if(db.lastPlayed) {
                const f = getFolder(db.lastPlayed.folderId);
                const v = f ? f.videos.find(x => x.id === db.lastPlayed.videoId) : null;
                if(f && v) {
                    hero.classList.remove('hidden');
                    document.getElementById('hero-title').innerText = f.name;
                    document.getElementById('hero-sub').innerText = v.title;
                } else hero.classList.add('hidden');
            } else hero.classList.add('hidden');

            db.folders.forEach(f => {
                const count = f.videos.length;
                const done = f.videos.filter(v => v.watched).length;
                const percent = count === 0 ? 0 : Math.round((done/count)*100);

                const el = document.createElement('div');
                el.className = "group bg-surface border border-border hover:border-primary-500/30 rounded-xl p-5 cursor-pointer transition-all hover:-translate-y-1";
                el.onclick = () => openFolder(f.id);
                el.innerHTML = `
                    <div class="flex justify-between items-start mb-6">
                        <div class="w-10 h-10 rounded-lg bg-surfaceHighlight flex items-center justify-center text-zinc-400 group-hover:text-primary-400 group-hover:bg-primary-500/10 transition-colors">
                            <i data-lucide="folder" class="w-5 h-5"></i>
                        </div>
                        <span class="text-[10px] font-mono bg-surfaceHighlight border border-border px-2 py-1 rounded-md text-zinc-500">${done}/${count}</span>
                    </div>
                    <h3 class="font-bold text-zinc-200 group-hover:text-white truncate mb-4">${escapeHtml(f.name)}</h3>
                    <div class="w-full bg-surfaceHighlight h-1 rounded-full overflow-hidden">
                        <div class="bg-primary-500 h-full rounded-full" style="width: ${percent}%"></div>
                    </div>
                `;
                grid.appendChild(el);
            });
            lucide.createIcons();
            
            // Clean up player
            if(player) {
                player.destroy();
                player = null;
            }
        }

        function openFolder(id) {
            activeFolderId = id;
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-player').classList.remove('hidden');
            renderSidebar();
            renderPlaylist();

            // Auto-load logic if not resuming
            if(!activeVideoId) {
                const f = getFolder(id);
                if(f.videos.length > 0) loadVideo(f.videos[0].id);
                else loadVideo(null);
            }
        }

        function loadVideo(id) {
            activeVideoId = id;
            if(!id) {
                document.getElementById('yt-player-mount').innerHTML = '<div class="w-full h-full flex items-center justify-center text-zinc-700"><i data-lucide="play" class="w-12 h-12"></i></div>';
                document.getElementById('player-title').innerText = "Select Video";
                document.getElementById('player-meta').innerText = "--";
                lucide.createIcons();
                return;
            }

            const f = getFolder(activeFolderId);
            const v = f.videos.find(x => x.id === id);
            
            document.getElementById('player-title').innerText = v.title;
            document.getElementById('player-meta').innerText = `${v.tag} • ${f.name}`;
            db.lastPlayed = { folderId: activeFolderId, videoId: id };
            save();

            if(!ytApiReady) {
                setTimeout(() => loadVideo(id), 500);
                return;
            }

            // Always create a fresh player to avoid state corruption from extensions
            if(player) player.destroy();
            
            // Ensure mount point exists
            const container = document.getElementById('video-container');
            if(!document.getElementById('yt-player-mount')) {
                const mount = document.createElement('div');
                mount.id = 'yt-player-mount';
                container.prepend(mount);
            }

            player = new YT.Player('yt-player-mount', {
                height: '100%',
                width: '100%',
                videoId: v.ytId,
                playerVars: { 'autoplay': 1, 'rel': 0, 'modestbranding': 1 },
                events: {
                    'onReady': onPlayerReady
                }
            });
            renderPlaylist();
        }

        function onPlayerReady(event) {
            // Restore speed setting
            const speedInput = document.querySelector('input[type="range"]');
            event.target.setPlaybackRate(parseFloat(speedInput.value));
        }

        // --- PLAYLIST UI ---
        function renderPlaylist() {
            const list = document.getElementById('playlist-container');
            list.innerHTML = '';
            const f = getFolder(activeFolderId);
            if(!f) return;

            const query = document.getElementById('playlist-search').value.toLowerCase();
            const videos = f.videos.filter(v => v.title.toLowerCase().includes(query));
            
            const done = f.videos.filter(v => v.watched).length;
            document.getElementById('playlist-stats').innerText = `${done}/${f.videos.length} Watched`;

            videos.forEach((v, idx) => {
                const isActive = v.id === activeVideoId;
                const el = document.createElement('div');
                el.draggable = true;
                el.ondragstart = (e) => dragStart(e, idx);
                el.ondragover = dragOver;
                el.ondrop = (e) => drop(e, idx);
                
                el.className = `p-3 rounded-lg cursor-pointer border flex gap-3 transition-all mb-1 ${isActive ? 'bg-primary-500/10 border-primary-500/30' : 'bg-surface border-transparent hover:border-border'}`;
                el.onclick = (e) => {
                    if(!e.target.closest('.no-trigger')) loadVideo(v.id);
                };

                el.innerHTML = `
                    <div class="no-trigger pt-1">
                        <label class="cursor-pointer">
                            <input type="checkbox" class="hidden" ${v.watched ? 'checked' : ''} onchange="toggleWatched('${v.id}')">
                            <div class="w-4 h-4 rounded border border-zinc-600 hover:border-zinc-400 bg-transparent flex items-center justify-center transition-colors">
                                ${v.watched ? '<div class="w-2.5 h-2.5 bg-emerald-500 rounded-sm"></div>' : ''}
                            </div>
                        </label>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h4 class="text-xs font-medium ${isActive ? 'text-primary-200' : 'text-zinc-300'} truncate mb-1">${escapeHtml(v.title)}</h4>
                        <div class="flex items-center gap-2">
                             <span class="text-[9px] px-1.5 py-0.5 rounded border border-border text-zinc-500 bg-background">${v.tag}</span>
                             ${isActive ? '<span class="w-1.5 h-1.5 bg-primary-500 rounded-full animate-pulse"></span>' : ''}
                        </div>
                    </div>
                    <div class="no-trigger opacity-0 group-hover:opacity-100 transition-opacity">
                         <button onclick="deleteVideo('${v.id}')" class="text-zinc-600 hover:text-red-400"><i data-lucide="trash" class="w-3.5 h-3.5"></i></button>
                    </div>
                `;
                list.appendChild(el);
            });
            lucide.createIcons();
        }

        function renderSidebar() {
            const list = document.getElementById('sidebar-list');
            list.innerHTML = '';
            
            db.folders.forEach(f => {
                const isActive = f.id === activeFolderId;
                const el = document.createElement('div');
                el.className = `px-3 py-2 rounded-lg cursor-pointer text-xs font-medium flex items-center gap-2 mb-0.5 transition-colors ${isActive ? 'text-white bg-surfaceHighlight border-r-2 border-primary-500' : 'text-zinc-500 hover:text-zinc-300 hover:bg-surfaceHighlight/50'}`;
                el.onclick = () => openFolder(f.id);
                el.innerHTML = `
                    <i data-lucide="${isActive ? 'folder-open' : 'folder'}" class="w-3.5 h-3.5"></i>
                    <span class="truncate flex-1">${escapeHtml(f.name)}</span>
                    ${f.videos.length > 0 ? `<span class="text-[9px] opacity-50">${f.videos.length}</span>` : ''}
                `;
                list.appendChild(el);
            });
            lucide.createIcons();
        }

        // --- PLAYER FEATURES ---
        function setSpeed(val) {
            document.getElementById('speed-val').innerText = parseFloat(val).toFixed(1) + 'x';
            if(player && player.setPlaybackRate) player.setPlaybackRate(parseFloat(val));
        }

        function toggleCinema() {
            document.body.classList.toggle('cinema-mode');
            document.getElementById('btn-cinema').classList.toggle('text-white');
            document.getElementById('btn-cinema').classList.toggle('bg-primary-500/20');
        }

        function toggleInvert() {
            const iframe = document.querySelector('iframe');
            if(iframe) {
                iframe.classList.toggle('filter-invert');
                document.getElementById('btn-invert').classList.toggle('text-primary-400');
            }
        }

        function toggleTheater() {
            const panel = document.getElementById('right-panel');
            if(panel.classList.contains('w-0')) {
                panel.classList.remove('w-0', 'border-0', 'overflow-hidden');
                panel.classList.add('w-80', 'border-l');
                document.getElementById('btn-theater').classList.remove('text-primary-400');
            } else {
                panel.classList.add('w-0', 'border-0', 'overflow-hidden');
                panel.classList.remove('w-80', 'border-l');
                document.getElementById('btn-theater').classList.add('text-primary-400');
            }
        }

        function toggleFocus() {
            document.body.classList.toggle('focus-mode');
            document.getElementById('btn-focus').classList.toggle('text-primary-400');
            // Force redraw
            window.dispatchEvent(new Event('resize'));
        }

        // Loop Logic
        function setLoopPoint(pt) {
            if(!player || !player.getCurrentTime) return;
            const t = player.getCurrentTime();
            if(pt === 'A') {
                loopStart = t;
                document.getElementById('btn-loop-a').classList.add('text-primary-400', 'bg-primary-500/10');
                toast(`Start: ${formatTime(t)}`);
            } else {
                loopEnd = t;
                document.getElementById('btn-loop-b').classList.add('text-primary-400', 'bg-primary-500/10');
                toast(`End: ${formatTime(t)}`);
            }
            if(loopStart !== null && loopEnd !== null) enableLoop(true);
        }

        function toggleLoop() {
            if(isLooping) enableLoop(false);
            else if(loopStart !== null && loopEnd !== null) enableLoop(true);
            else toast('Set A & B first', 'error');
        }

        function enableLoop(enabled) {
            isLooping = enabled;
            const btn = document.getElementById('btn-loop-toggle');
            if(enabled) {
                btn.classList.add('text-primary-400');
                if(loopInterval) clearInterval(loopInterval);
                loopInterval = setInterval(() => {
                    if(player && player.getCurrentTime) {
                        const t = player.getCurrentTime();
                        if(t > loopEnd || t < loopStart) player.seekTo(loopStart);
                    }
                }, 500);
                toast('Loop Active');
            } else {
                btn.classList.remove('text-primary-400');
                clearInterval(loopInterval);
                toast('Loop Off');
            }
        }

        // --- UTILS ---
        function escapeHtml(text) { return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }
        function formatTime(s) { return new Date(s * 1000).toISOString().substr(14, 5); }
        function toast(msg, type='success') {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            const i = document.getElementById('toast-icon');
            if(type==='error') { i.setAttribute('data-lucide','alert-circle'); i.className="w-4 h-4 text-red-400"; }
            else { i.setAttribute('data-lucide','check-circle'); i.className="w-4 h-4 text-emerald-400"; }
            lucide.createIcons();
            t.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000);
        }

        // --- DRAG & DROP & MODALS ---
        let dragIdx = null;
        function setupDragDrop() {
            document.addEventListener('dragend', () => {
                document.getElementById('drag-overlay').classList.add('hidden');
                renderPlaylist();
            });
        }
        function dragStart(e, idx) {
            dragIdx = idx;
            document.getElementById('drag-overlay').classList.remove('hidden');
        }
        function dragOver(e) { e.preventDefault(); }
        function drop(e, targetIdx) {
            e.preventDefault();
            const f = getFolder(activeFolderId);
            const item = f.videos.splice(dragIdx, 1)[0];
            f.videos.splice(targetIdx, 0, item);
            save();
            renderPlaylist();
        }

        function openModal(name) {
            const m = document.getElementById('modal-' + name);
            const o = document.getElementById('modal-overlay');
            o.classList.remove('hidden'); m.classList.remove('hidden');
            setTimeout(() => { o.classList.remove('opacity-0'); m.classList.remove('opacity-0', 'scale-95'); }, 10);
            
            if(name === 'video') {
                document.getElementById('inp-video-tag').value = 'Lecture';
                updateTagVisuals();
            }
            if(name === 'edit-folder') document.getElementById('inp-edit-name').value = getFolder(activeFolderId).name;
        }

        function closeModals() {
            const o = document.getElementById('modal-overlay');
            const modals = document.querySelectorAll('[id^="modal-"]:not(#modal-overlay)');
            o.classList.add('opacity-0');
            modals.forEach(m => m.classList.add('opacity-0', 'scale-95'));
            setTimeout(() => { o.classList.add('hidden'); modals.forEach(m => m.classList.add('hidden')); }, 300);
        }

        // Form Logic
        function createFolder() {
            const name = document.getElementById('inp-folder-name').value;
            if(!name) return;
            db.folders.push({id: uid(), name: name, videos: []});
            save(); renderDashboard(); closeModals();
        }

        function addVideo() {
            const url = document.getElementById('inp-video-url').value;
            const title = document.getElementById('inp-video-title').value;
            const tag = document.getElementById('inp-video-tag').value;
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            const ytId = (match && match[2].length === 11) ? match[2] : null;
            if(!ytId) { toast('Invalid URL', 'error'); return; }

            const f = getFolder(activeFolderId);
            const vid = uid();
            f.videos.push({ id: vid, ytId: ytId, title: title || `Lecture ${f.videos.length + 1}`, tag: tag, watched: false });
            save(); renderPlaylist(); closeModals();
            if(f.videos.length === 1) loadVideo(vid);
        }

        function deleteVideo(id) {
            if(!confirm('Remove?')) return;
            const f = getFolder(activeFolderId);
            f.videos = f.videos.filter(v => v.id !== id);
            save();
            if(activeVideoId === id) loadVideo(null);
            renderPlaylist();
        }

        function toggleWatched(id) {
            const f = getFolder(activeFolderId);
            const v = f.videos.find(x => x.id === id);
            v.watched = !v.watched;
            save(); renderPlaylist();
        }

        function deleteCurrentFolder() {
            if(!confirm('Delete Folder?')) return;
            db.folders = db.folders.filter(f => f.id !== activeFolderId);
            save(); renderDashboard(); closeModals();
        }

        function saveEditFolder() {
            const f = getFolder(activeFolderId);
            f.name = document.getElementById('inp-edit-name').value;
            save(); closeModals();
            if(activeVideoId) document.getElementById('player-meta').innerText = `${f.videos.find(v=>v.id===activeVideoId).tag} • ${f.name}`;
        }

        function setTag(t) {
            document.getElementById('inp-video-tag').value = t;
            updateTagVisuals();
        }

        function updateTagVisuals() {
            const t = document.getElementById('inp-video-tag').value;
            document.querySelectorAll('.tag-btn').forEach(b => {
                if(b.dataset.tag === t) b.className = "tag-btn text-xs border rounded-lg py-2 transition-colors border-primary-500/50 bg-primary-500/10 text-primary-400";
                else b.className = "tag-btn text-xs border border-border text-zinc-500 rounded-lg py-2 hover:bg-surfaceHighlight transition-colors";
            });
        }

        function toggleMobileSidebar() {
            document.getElementById('sidebar').classList.toggle('-translate-x-full');
        }

        function resumeLast() {
            if(db.lastPlayed) openFolder(db.lastPlayed.folderId);
        }

        function exportData() {
            const s = JSON.stringify(db);
            const b = new Blob([s], {type: 'application/json'});
            const u = URL.createObjectURL(b);
            const a = document.createElement('a');
            a.href = u; a.download = `studyos-backup-${new Date().toISOString().slice(0,10)}.json`; a.click();
        }

        function processImport(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    if(json.folders) { db = json; save(); init(); toast('Data Imported'); }
                } catch(err) { toast('Import Failed', 'error'); }
            };
            reader.readAsText(file);
        }

        window.onload = init;
    </script>
</body>
</html>
